<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

<link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🥥&lt;/text&gt;&lt;/svg&gt;">


<style>
  :root {
    font-size: 20px;
}
</style>
  <title>
    配置 cargo workspace&nbsp;|&nbsp;413’s Website
  </title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="配置 cargo workspace">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🥥&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="Note.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🎶&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Note</span>
    </div>
  </a>
  
  
  
  
  
  
  
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="reference.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;📖&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>杂项</span>
    </div>
  </a>
  
  
  
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="About.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>About</span>
    </div>
  </a>
  
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">
      配置 cargo workspace
    </h1>
    
    <div class="DateTagBar">
      
      <span class="DateTagBar__Item DateTagBar__Date">Posted on Mon, Sep 2, 2024</span>
      
      
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
        <a href="tag/Rust.html">
          Rust
        </a>
      </span>
      
      <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
        <a href="tag/单片机.html">
          单片机
        </a>
      </span>
      
    </div>
    
  </header>
  <article id="https://www.notion.so/aa7a4860f931439aa1defeaff51e1301" class="PageRoot"><div id="https://www.notion.so/b4bc43cfd16e40b18ab58a6e8f576638" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">在 ~/code/esp32 下创建 std/non_std 两个目录，分别作为 std 和 non_std 应用的 workspace 目录， 之所以区分他们是因为 workspace 目录下的 .cargo/config.toml 文件配置不同：</mark></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/73ca1d75cf7c4cc4868e5f47f3255aaf" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">std workspace：创建 Cargo.toml，从一个 std 应用目录拷贝.cargo/config.toml/rust-toolchain.toml/sdkconfig.defaults 文件；</mark></span></span></li><li id="https://www.notion.so/d3523f3980e84554a8603b47df043d95" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">non_std workspace: 创建 Cargo.toml，从一个 non_std 应用目录拷贝.cargo/config.toml/rust-toolchain.toml/sdkconfig.defaults 文件；</mark></span></span></li></ol><div id="https://www.notion.so/546fb1ae22c648e0b295a2c243b7b4ab" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">std workspace：</mark></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/833646d59b4548ec8e9c24c8fc76c4dc" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">.cargo/config.toml 中设置最新的 ESP_IDF_VERSION = “v5.2.1”，没有指定 ESP_IDF_TOOLS_INSTALL_DIR = “global”，这样会在 workspace 目录下的 .embuild 中保存一份。</mark></span></span></li></ol><div id="https://www.notion.so/5d16efbb467e4e0cb164fb8cf9bd7044" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/ed9fc4a80c864f9396f7107c270500a3" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>zj@a:~/code/esp32/std$ cat Cargo.toml
[workspace]
resolver = &quot;2&quot; # 没有指定 workspace 的 root package 时必须要指定该参数
members = [  # std 应用目录列表
  &quot;myesp&quot;,
  &quot;myespv2&quot;,
  &quot;myespv3&quot;,
]

exclude = [ # 排除的目录列表
  &quot;mycmake&quot;,
  &quot;old&quot;,
]

[profile.release]
opt-level = &quot;s&quot;

[profile.dev]
debug = true    # Symbols are nice and they don&#x27;t increase the size on Flash
opt-level = &quot;z&quot;
zj@a:~/code/esp32/std$
zj@a:~/code/esp32/std$ cat .cargo/config.toml
[build]
target = &quot;xtensa-esp32s3-espidf&quot;

[target.xtensa-esp32s3-espidf]
linker = &quot;ldproxy&quot;
# runner = &quot;espflash --monitor&quot; # Select this runner for espflash v1.x.x
runner = &quot;espflash flash --monitor&quot; # Select this runner for espflash v2.x.x
rustflags = [ &quot;--cfg&quot;,  &quot;espidf_time64&quot;] # Extending time_t for ESP IDF 5: https://github.com/esp-rs/rust/issues/110

[unstable]
build-std = [&quot;std&quot;, &quot;panic_abort&quot;]

[env]
MCU=&quot;esp32s3&quot;
# Note: this variable is not used by the pio builder (`cargo build --features pio`)
ESP_IDF_VERSION = &quot;v5.2.1&quot;
ESP_IDF_SDKCONFIG_DEFAULTS = { value = &quot;sdkconfig.defaults&quot;, relative = true }

zj@a:~/code/esp32/std$ cat rust-toolchain.toml
[toolchain]
channel = &quot;esp&quot;</span></span></span></code></pre><div id="https://www.notion.so/d604a4b925424ea784e50aee5aab066b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">non_std workspace:</mark></span></span></p></div><div id="https://www.notion.so/c423ab789c4f4e108d73ea9577bbc117" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/1829ef6c0c3b49669130a271dbb2f695" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>zj@a:~/code/esp32/non_std$ cat Cargo.toml
[workspace]
resolver = &quot;2&quot;
members = [
  &quot;myesp-nonstd&quot;
]

[profile.dev]
# Rust debug is too slow.
# For debug builds always builds with some optimization
opt-level = &quot;s&quot;

[profile.release]
codegen-units = 1 # LLVM can perform better optimizations using a single thread
debug = 2
debug-assertions = false
incremental = false
lto = &#x27;fat&#x27;
opt-level = &#x27;s&#x27;
overflow-checks = false

zj@a:~/code/esp32/non_std$ cat .cargo/config.toml
[target.xtensa-esp32s3-none-elf]
runner = &quot;espflash flash --monitor&quot;


[env]
ESP_LOGLEVEL=&quot;INFO&quot;

[build]
rustflags = [
  &quot;-C&quot;, &quot;link-arg=-nostartfiles&quot;,
]

target = &quot;xtensa-esp32s3-none-elf&quot;

[unstable]
build-std = [&quot;core&quot;]

zj@a:~/code/esp32/non_std$ cat rust-toolchain.toml
[toolchain]
channel = &quot;esp&quot;
zj@a:~/code/esp32/non_std$</span></span></span></code></pre><div id="https://www.notion.so/21b4724d3ec34105a811103ac4d43edc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">新增应用：</mark></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/f584bb561569428d8a362c771c2376d7" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">在对应的 std/non_std 目录下使用 cargo generate 模板来创建应用。</mark></span></span></li><li id="https://www.notion.so/c591bc78b99640e1a6f11cdfdf90c20b" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">然后将应用名称添加到 members 列表中；</mark></span></span></li></ol><div id="https://www.notion.so/8a8e96bc88614a6dbe4be25d57a5bb8f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">构建应用：</mark></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/0bd262d4726b44b4bf1c9457c373047b" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">在 std/non_std workspace 根目录下： cargo build -p app1</mark></span></span></li><li id="https://www.notion.so/a98d0677bec84904a48f22132a1cc58e" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">在特定应用目录，如 std/myespv2 目录下： cargo build # 只构建当前应用</mark></span></span></li></ol><div id="https://www.notion.so/5a453947428b4d6490f9b6dc3cfa9dbf" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">当应用位于 workspace 中（members 列表中） 时，cargo build </mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault"><code class="SemanticString__Fragment SemanticString__Fragment--Code">不再读取应用目录中的</code></mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault"> 下列文件，而是都使用 workspaces 目录下的对应文件。</mark></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/6b2a5885b0694dadafb8ee6ff9671d1e" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">rust-toolchain.toml</mark></span></span></li><li id="https://www.notion.so/08fe51c77d9141928dc2733340f73514" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">.cargo/config.toml</mark></span></span></li><li id="https://www.notion.so/c19f99449d4a40c2b8e2a57126d18b8a" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">sdkconfig.defaults 和 sdkconfig.defaults.esp32s3 # 相对与 workspace 目录。</mark></span></span></li></ol><div id="https://www.notion.so/627778404de7454c9afeb0abd20c6c2d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">但是应用目录下的 Cargo.toml 和 build.rs 还是必须的，分别指定各应用自身的依赖和构建脚本。</mark></span></span></p></div></article>
  <footer class="Footer">
  <div>
    &copy; 413’s Website 2020~2024
  </div>
  <div>
    &centerdot;
  </div>
  <div>
    Powered by
    <a href="https://github.com/syx-413" target="_blank" rel="noopener noreferrer"> notablog</a>.
  </div>
</footer>
</body>

</html>