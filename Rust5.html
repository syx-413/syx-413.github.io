<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<link rel="stylesheet" type="text/css" href="css/CustomSetting.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🥥&lt;/text&gt;&lt;/svg&gt;">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>开发 Rust/C/C++ cmake 混合应用&nbsp;|&nbsp;413’s Website</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="开发 Rust/C/C++ cmake 混合应用">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦀&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🥥&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="blog-collection.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🥅&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>blog mark</span>
    </div>
  </a>
  
  
  
  
  
  
  
  
  
  
  
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="Note.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🎶&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>Note</span>
    </div>
  </a>
  
  
  
  
  
  
  
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="reference.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😷&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>杂项</span>
    </div>
  </a>
  
  
  
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="About.html">
    <div class="Navbar__Btn">
      
      <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;😀&lt;/text&gt;&lt;/svg&gt;"></span>&nbsp;
      
      <span>About</span>
    </div>
  </a>
  
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;🦀&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">开发 Rust/C/C++ cmake 混合应用</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on Mon, Sep 2, 2024</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--purple">
            <a href="tag/Rust.html">Rust</a>
          </span>
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--red">
            <a href="tag/单片机.html">单片机</a>
          </span>
        
      </div>
    
  </header>
    <div id="content-html"></div>
  <article id="https://www.notion.so/853550177536422e92cb8471dbaa3e31" class="PageRoot PageRoot--FullWidth"><div id="https://www.notion.so/c258340531f8470a84357702a45bc824" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">esp-idf 支持链接 C/C++ 或 Rust 编写的 component，而使用 cargo generate esp-rs/esp-idf-template cmake来创建 Rust + C/C++ 混合风格的 std 或 non_std 应用，该应用使用安装的 ~/esp/esp-idf/v5.2.1/ 中的idf.py 和 cmake 来构建。</mark></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/fcad0c4f7fa444c99a500e0e8c41e110" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Rust 代码作为一个 component 来集成：components/rust-xxx；</mark></span></span></li><li id="https://www.notion.so/c56a2abd724a4823b363174cbb1964b9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Rust Component 目录的 CMakeLists.txt 文件会调用 cargo build 来将 Rust 代码编译为 esp-idf C 库可以调用的静态库。</mark></span></span></li><li id="https://www.notion.so/87c3a41a62a5462cb19bc07de90741d5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">该 Rust Compoent 可以是 std 或 non_std 类型。由于 idf.py 已经提供了 esp-idf 库，所以 Rust 代码的 build.rs 不会向 std 应用那样 by 项目下载、编译和链接新的 esp-idf 库，而是直接链接 idf.py 所在的 esp-idf 库。</mark></span></span></li></ul><div id="https://www.notion.so/8839a870b18540efaee1bcfce47bba02" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">默认创建启用 HAL（ esp-idf-svc）的 std 应用。</mark></span></span></p></div><div id="https://www.notion.so/091988adc815451e9f9e3c443fc3d9df" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Rust cmake 读取和使用的参数：</mark></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/921835712f504f59b7029946ffc00ada" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">RUST_DEPS</mark></span></span></li><li id="https://www.notion.so/d1dc9e0295254f2e9ef1ee993efba732" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">CONFIG_IDF_TARGET_ARCH_RISCV</mark></span></span></li><li id="https://www.notion.so/e4da5a14c16a4eec87f927822bf50f7e" class="NumberedList" value="3"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">SDKCONFIG</mark></span></span></li><li id="https://www.notion.so/bc382047565f44a292c195057a4eb8d5" class="NumberedList" value="4"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">IDF_PATH</mark></span></span></li></ol><div id="https://www.notion.so/f6899389e1a44fbaa8696d4c44cba107" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">使用 cargo generate esp-rs/esp-idf-template cmake 创建应用：</mark></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/c38279ff7edd4b9da8b2ccc4743b24b2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">components/rust-mycmake/CMakeLists.txt 文件封装了构建该 Rust component 的 cargo 命令和参数（没有了.cargo/config.toml 配置，相当于替换了该文件的功能）：</mark></span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/c1405b58669041f49192d4f86a4995d2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Rust target：xtensa-esp32s3-espidf</mark></span></span></li><li id="https://www.notion.so/c700f2a8607f45c990a62363dec495ee" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Rust flags： –cfg espidf_time64</mark></span></span></li></ul></li><li id="https://www.notion.so/a77f00fa58a642ddb1d6f15a3e234184" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">与 std 默认启用所有 esp-idf components 相比，cmake 项目默认只启用了很少的几个 components，需要在 components/rust-{{project-name}}/CMakeLists.txt 文件中设置 </mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault"><code class="SemanticString__Fragment SemanticString__Fragment--Code">RUST_DEPS</code></mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault"> 来启用 Rust 依赖的 component；</mark></span></span></li></ul><div id="https://www.notion.so/07f142b86d574e238e733338335e25d2" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">构建前需要 </mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault"><code class="SemanticString__Fragment SemanticString__Fragment--Code">同时 source</code></mark></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault"> esp-idf 的 export.h 和 export-esp.sh。</mark></span></span></p></div><div id="https://www.notion.so/b94bc8f714484826ac1467468048dc5f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">构建命令是 idf.py build 而非 cargo build。</mark></span></span></p></div><div id="https://www.notion.so/4c454d22b610469cb668a58ba6b34f99" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">创建项目，默认是 std 应用</mark></span></span></p></div><div id="https://www.notion.so/e17352a268ca4cf998acc1dfddefa575" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/eeba248a46054799871494d64f111867" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>zj@a:~/code/esp32$ cargo generate esp-rs/esp-idf-template cmake
⚠️   Favorite `esp-rs/esp-idf-template` not found in config, using it as a git repository: https://github.com/esp-rs/esp-idf-template.git
🤷   Project Name: mycmake
🔧   Destination: /Users/alizj/code/esp32/mycmake ...
🔧   project-name: mycmake ...
🔧   Generating template ...
✔ 🤷   Configure advanced template options? · true
✔ 🤷   Rust toolchain (beware: nightly works only for riscv MCUs!) · esp
✔ 🤷   Enable HAL support? · true
✔ 🤷   Enable STD support? · true
🔧   Moving generated files into: `/Users/alizj/code/esp32/mycmake`...
🔧   Initializing a fresh Git repository
✨   Done! New project created /Users/alizj/code/esp32/mycmake

zj@a:~/code/esp32/mycmake$ ls
CMakeLists.txt  components/  diagram.json  main/  sdkconfig.defaults  wokwi.toml

zj@a:~/code/esp32/mycmake$ ls main/
CMakeLists.txt  main.c</span></span></span></code></pre><div id="https://www.notion.so/ecc73abdf8754783a1ff33de266c103f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Rust 代码作为一个 component 被集成：</mark></span></span></p></div><div id="https://www.notion.so/14511a9c3d10439d852411254067d0eb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/505911a1ada44d65a8c30e2b5e7b9120" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>zj@a:~/code/esp32/mycmake$ ls components/rust-mycmake/
CMakeLists.txt  Cargo.toml  build.rs  placeholder.c  rust-toolchain.toml  src/

zj@a:~/code/esp32/mycmake$ ls components/rust-mycmake/src/
lib.rs</span></span></span></code></pre><div id="https://www.notion.so/018ad7751e4d409089391e164fa21db1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Rust componet 的 CMakeLists.txt 文件封装了构建该 Rust 代码的 cargo 命令和配置参数。</mark></span></span></p></div><div id="https://www.notion.so/79405423cd7f406fbb1b435e9bb8a0ed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/eb5360f9c1d643d09f17b4b9176aad4e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>zj@a:~/code/esp32/mycmake/components/rust-mycmake$ cat CMakeLists.txt
# If this component depends on other components - be it ESP-IDF or project-specific ones - enumerate those in the double-quotes below, separated by spaces
# Note that pthread should always be there, or else STD will not work
set(RUST_DEPS &quot;pthread&quot; &quot;driver&quot; &quot;vfs&quot;)
# Here&#x27;s a non-minimal, reasonable set of ESP-IDF components that one might want enabled for Rust:
#set(RUST_DEPS &quot;pthread&quot; &quot;esp_http_client&quot; &quot;esp_http_server&quot; &quot;espcoredump&quot; &quot;app_update&quot; &quot;esp_serial_slave_link&quot; &quot;nvs_flash&quot; &quot;spi_flash&quot; &quot;esp_adc_cal&quot; &quot;mqtt&quot;)

idf_component_register(
    SRCS &quot;placeholder.c&quot;
    INCLUDE_DIRS &quot;&quot;
    PRIV_REQUIRES &quot;${RUST_DEPS}&quot;
)

if(CONFIG_IDF_TARGET_ARCH_RISCV)
    if (CONFIG_IDF_TARGET_ESP32C6 OR CONFIG_IDF_TARGET_ESP32C5 OR CONFIG_IDF_TARGET_ESP32H2)
        set(RUST_TARGET &quot;riscv32imac-esp-espidf&quot;)
    else ()
        set(RUST_TARGET &quot;riscv32imc-esp-espidf&quot;)
    endif()
elseif(CONFIG_IDF_TARGET_ESP32)
    set(RUST_TARGET &quot;xtensa-esp32-espidf&quot;)
elseif(CONFIG_IDF_TARGET_ESP32S2)
    set(RUST_TARGET &quot;xtensa-esp32s2-espidf&quot;)
elseif(CONFIG_IDF_TARGET_ESP32S3)
    set(RUST_TARGET &quot;xtensa-esp32s3-espidf&quot;)
else()
    message(FATAL_ERROR &quot;Unsupported target ${CONFIG_IDF_TARGET}&quot;)
endif()

if(CMAKE_BUILD_TYPE STREQUAL &quot;Debug&quot;)
    set(CARGO_BUILD_TYPE &quot;debug&quot;)
    set(CARGO_BUILD_ARG &quot;&quot;)
else()
    set(CARGO_BUILD_TYPE &quot;release&quot;)
    set(CARGO_BUILD_ARG &quot;--release&quot;)
endif()


set(CARGO_BUILD_STD_ARG -Zbuild-std=std,panic_abort)


if(IDF_VERSION_MAJOR GREATER &quot;4&quot;)
set(ESP_RUSTFLAGS &quot;--cfg espidf_time64&quot;)
endif()

set(CARGO_PROJECT_DIR &quot;${CMAKE_CURRENT_LIST_DIR}&quot;)
set(CARGO_BUILD_DIR &quot;${CMAKE_CURRENT_BINARY_DIR}&quot;)
set(CARGO_TARGET_DIR &quot;${CARGO_BUILD_DIR}/target&quot;)

set(RUST_INCLUDE_DIR &quot;${CARGO_TARGET_DIR}&quot;)
set(RUST_STATIC_LIBRARY &quot;${CARGO_TARGET_DIR}/${RUST_TARGET}/${CARGO_BUILD_TYPE}/librust_mycmake.a&quot;)

# if this component uses CBindGen to generate a C header, uncomment the lines below and adjust the header name</span></span><span class="SemanticString"><span> accordingly
#set(RUST_INCLUDE_HEADER &quot;${RUST_INCLUDE_DIR}/RustApi.h&quot;)
#set_source_files_properties(&quot;${RUST_INCLUDE_HEADER}&quot; PROPERTIES GENERATED true)

idf_build_get_property(sdkconfig SDKCONFIG)
idf_build_get_property(idf_path IDF_PATH)

ExternalProject_Add(
    project_rust_mycmake
    PREFIX &quot;${CARGO_PROJECT_DIR}&quot;
    DOWNLOAD_COMMAND &quot;&quot;
    CONFIGURE_COMMAND ${CMAKE_COMMAND} -E env
        cargo clean --target ${RUST_TARGET} --target-dir ${CARGO_TARGET_DIR}
    USES_TERMINAL_BUILD true
    BUILD_COMMAND ${CMAKE_COMMAND} -E env
        CARGO_CMAKE_BUILD_INCLUDES=$&lt;TARGET_PROPERTY:${COMPONENT_LIB},INCLUDE_DIRECTORIES&gt;
        CARGO_CMAKE_BUILD_LINK_LIBRARIES=$&lt;TARGET_PROPERTY:${COMPONENT_LIB},LINK_LIBRARIES&gt;
        CARGO_CMAKE_BUILD_SDKCONFIG=${sdkconfig}
        CARGO_CMAKE_BUILD_ESP_IDF=${idf_path}
        CARGO_CMAKE_BUILD_COMPILER=${CMAKE_C_COMPILER}
        RUSTFLAGS=${ESP_RUSTFLAGS}
        MCU=${CONFIG_IDF_TARGET}
        cargo build --target ${RUST_TARGET} --target-dir ${CARGO_TARGET_DIR} ${CARGO_BUILD_ARG} ${CARGO_BUILD_STD_ARG}
    INSTALL_COMMAND &quot;&quot;
    BUILD_ALWAYS TRUE
    TMP_DIR &quot;${CARGO_BUILD_DIR}/tmp&quot;
    STAMP_DIR &quot;${CARGO_BUILD_DIR}/stamp&quot;
    DOWNLOAD_DIR &quot;${CARGO_BUILD_DIR}&quot;
    SOURCE_DIR &quot;${CARGO_PROJECT_DIR}&quot;
    BINARY_DIR &quot;${CARGO_PROJECT_DIR}&quot;
    INSTALL_DIR &quot;${CARGO_BUILD_DIR}&quot;
    BUILD_BYPRODUCTS
        &quot;${RUST_INCLUDE_HEADER}&quot;
        &quot;${RUST_STATIC_LIBRARY}&quot;
)

add_prebuilt_library(library_rust_mycmake &quot;${RUST_STATIC_LIBRARY}&quot; PRIV_REQUIRES &quot;${RUST_DEPS}&quot;)
add_dependencies(library_rust_mycmake project_rust_mycmake)

target_include_directories(${COMPONENT_LIB} PUBLIC &quot;${RUST_INCLUDE_DIR}&quot;)
target_link_libraries(${COMPONENT_LIB} PRIVATE library_rust_mycmake)</span></span></span></code></pre><div id="https://www.notion.so/8372399c876342f69ce73b45387c514b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">配置了 crate-type 为 staticlib，故会被编译为 esp-idf 可以链接的 C 库</mark></span></span></p></div><div id="https://www.notion.so/a70eb57241fb45d1a6c65749ea7b177c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/690866645d2343c785061838d2d9fdcb" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>zj@a:~/code/esp32/mycmake/components/rust-mycmake$ cat Cargo.toml
[package]
name = &quot;rust-mycmake&quot;
version = &quot;0.1.0&quot;
authors = [&quot;alizj&quot;]
edition = &quot;2021&quot;
resolver = &quot;2&quot;
rust-version = &quot;1.71&quot;

[lib]
crate-type = [&quot;staticlib&quot;]

[profile.release]
opt-level = &quot;s&quot;

[profile.dev]
debug = true # Symbols are nice and they don&#x27;t increase the size on Flash
opt-level = &quot;z&quot;
[features]
default = [&quot;std&quot;, &quot;embassy&quot;, &quot;esp-idf-svc/native&quot;]

pio = [&quot;esp-idf-svc/pio&quot;]
std = [&quot;alloc&quot;, &quot;esp-idf-svc/std&quot;]
alloc = [&quot;esp-idf-svc/alloc&quot;]
nightly = [&quot;esp-idf-svc/nightly&quot;]
experimental = [&quot;esp-idf-svc/experimental&quot;]
embassy = [&quot;esp-idf-svc/embassy-sync&quot;, &quot;esp-idf-svc/critical-section&quot;, &quot;esp-idf-svc/embassy-time-driver&quot;]

[dependencies]
log = { version = &quot;0.4&quot;, default-features = false }
esp-idf-svc = { version = &quot;0.48&quot;, default-features = false }

[build-dependencies]
embuild = &quot;0.31.3&quot;

# 编译为 staticlib，可以被 C 库调用的 Rust 代码
zj@a:~/code/esp32/mycmake/components/rust-mycmake$ cat src/lib.rs
#[no_mangle]
extern &quot;C&quot; fn rust_main() -&gt; i32 {
    // It is necessary to call this function once. Otherwise some patches to the runtime
    // implemented by esp-idf-sys might not link properly. See https://github.com/esp-rs/esp-idf-template/issues/71
    esp_idf_svc::sys::link_patches();

    // Bind the log crate to the ESP Logging facilities
    esp_idf_svc::log::EspLogger::initialize_default();

    log::info!(&quot;Hello, world!&quot;);
    42
}

zj@a:~/code/esp32/mycmake/components/rust-mycmake$ cat placeholder.c
/* Hello World Example

   This example code is in the Public Domain (or CC0 licensed, at your option.)

   Unless required by applicable law or agreed to in writing, this
   software is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
   CONDITIONS OF ANY KIND, either express or implied.
*/

/* This is an empty source file to force the build of a CMake library that
   can participate in the CMake dependency graph. This placeholder library
   will depend on the actual library generated by external R</span></span><span class="SemanticString"><span>ust build.
*/

# main.c 中调用 Rust 的 rust_main() 函数代码
zj@a:~/code/esp32/mycmake$ cat main/main.c
/* Hello World Example

   This example code is in the Public Domain (or CC0 licensed, at your option.)

   Unless required by applicable law or agreed to in writing, this
   software is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR
   CONDITIONS OF ANY KIND, either express or implied.
*/
#include &lt;stdio.h&gt;

extern int rust_main(void);

void app_main(void) {
    printf(&quot;Hello world from C!\n&quot;);

    int result = rust_main();

    printf(&quot;Rust returned code: %d\n&quot;, result);
}</span></span></span></code></pre><div id="https://www.notion.so/c48106f35f3f4468b4830cda09317b33" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">构建前需要 source esp-idf 的 export.h 和 export-esp.sh：</mark></span></span></p></div><div id="https://www.notion.so/345501c6422c44aa868aad83d9e59774" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/0cd49f4b6b06491f8e625aabd1a33c87" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>zj@a:~/code/esp32/mycmake$ source ~/esp/esp-idf/v5.2.1/export.sh   # esp idf
zj@a:~/code/esp32/mycmake$ source ~/export-esp.sh   # esp rs，因为后续会 build Rust component</span></span></span></code></pre><div id="https://www.notion.so/23512f23975c4705a97d29e56451835b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">构建：</mark></span></span></p></div><div id="https://www.notion.so/b7d5d11db45d42d2a268f5d88e695a97" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/5dc6bfde63d2409eab25f5fa9867adf2" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>#idf.py set-target [esp32|esp32s2|esp32s3|esp32c2|esp32c3|esp32c6|esp32h2]
zj@a:~/code/esp32/mycmake$ idf.py build
Executing action: all (aliases: build)
Running ninja in directory /Users/alizj/code/esp32/mycmake/build
Executing &quot;ninja all&quot;...
[0/9] Performing build step for &#x27;project_rust_mycmake&#x27;    Finished release [optimized] target(s) in 0.25s
[1/1] cd /Users/alizj/code/esp32/mycmake/build/bootloader/esp-idf/esptool_py &amp;&amp; /Users/alizj/.espressif/p...izes.py --offset 0x8000 bootloader 0x1000 /Users/alizj/code/esp32/mycmake/build/bootloader/bootloader.bi
Bootloader binary size 0x6860 bytes. 0x7a0 bytes (7%) free.
[3/3] cd /Users/alizj/code/esp32/mycmake/build/esp-idf/esptool_py &amp;&amp; /Users/alizj/.espressif/python_env/i...esp32/mycmake/build/partition_table/partition-table.bin /Users/alizj/code/esp32/mycmake/build/mycmake.bi
mycmake.bin binary size 0x5b770 bytes. Smallest app partition is 0x100000 bytes. 0xa4890 bytes (64%) free.

Project build complete. To flash, run:
 idf.py flash
or
 idf.py -p PORT flash
or
 python -m esptool --chip esp32 -b 460800 --before default_reset --after hard_reset write_flash --flash_mode dio --flash_size 2MB --flash_freq 40m 0x1000 build/bootloader/bootloader.bin 0x8000 build/partition_table/partition-table.bin 0x10000 build/mycmake.bin
or from the &quot;/Users/alizj/code/esp32/mycmake/build&quot; directory
 python -m esptool --chip esp32 -b 460800 --before default_reset --after hard_reset write_flash &quot;@flash_args&quot;

# 构建的产物位于 build 目录下 。</span></span></span></code></pre><div id="https://www.notion.so/3990b32b9e4042e6841fa5b7537d042c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">烧录到设备 flash</mark></span></span></p></div><div id="https://www.notion.so/c21a10feced74a469acf1a062edc0499" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Copy</mark></span></span></p></div><pre id="https://www.notion.so/75334e2c782a4068b669fc22627a7aca" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>idf.py -p /dev/cu.usbmodem2101 flash monitor</span></span></span></code></pre><div id="https://www.notion.so/8066a0d06bcc49dea71c7c5731cd13c3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">参考:</mark></span></span></p></div><ol class="NumberedListWrapper"><li id="https://www.notion.so/5250b87c5b304bba9a0a90268c4c6dad" class="NumberedList" value="1"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/esp-rs/esp-idf-template/blob/master/README-cmake.md"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">esp-idf-template 的 cmake 文档</mark></a></span><span class="SemanticString"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">;</mark></span></span></li><li id="https://www.notion.so/7a2dcb71348d4427b8d8babef9816c07" class="NumberedList" value="2"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/esp-rs/esp-idf-template/blob/master/README-cmake-details"><mark class="SemanticString__Fragment SemanticString__Fragment--HighlightedColor SemanticString__Fragment--ColorDefault">Integrating a Rust Component into an ESP-IDF Project</mark></a></span></span></li></ol></article>
    <aside class="Aside">
        <a href="#content-html"><div id="up">👆</div></a>
        <a href="#message-board"><div id="down">👇</div></a>
    </aside>
    <div id="message-board"></div>
    <script src="https://utteranc.es/client.js"
        repo="syx-413/syx-413.github.io"
        issue-term="pathname"
        theme="boxy-light"
        crossorigin="anonymous"
        async>
    </script>
    
  <footer class="Footer">
  <div>
    &copy; 413’s Website 2020~2024
  </div>
  <div>
    &centerdot;
  </div>
  <div>
    Powered by
    <a href="https://github.com/syx-413" target="_blank" rel="noopener noreferrer"> notablog</a>.
  </div>
</footer>
</body>

</html>